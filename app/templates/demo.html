{% extends "base.html" %}

{% block title %}Demo | DogArmor{% endblock %}

{% block content %}

<section class="bg-gradient-to-b from-green-100 to-green-400 min-h-screen">
  <!-- Demo Section -->
  <div class="py-16 px-6 max-w-6xl mx-auto" data-aos="zoom-in">
    <h1 class="text-5xl font-extrabold text-green-700 text-center mb-12 flex items-center justify-center gap-4">
      <i data-lucide="activity" class="w-10 h-10 text-green-700"></i>
      Try the Recommendation Demo
    </h1>

    <form id="demo-form" class="space-y-6 bg-white p-8 rounded-2xl border border-gray-200 shadow-md">
      <!-- Derived from image -->
      <fieldset class="border border-gray-200 rounded-md p-4 space-y-4">
        <legend class="text-lg font-medium text-green-700 px-2 mb-2" style="margin-top: -1.5rem;">
          Information derived from photo of dog:
        </legend>

        <div>
          <label class="block text-sm font-medium text-gray-700">Upload Dog Photo</label>
          <input type="file" name="image" id="dog_image" accept="image/*"
                 class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" required>
        </div>

        <div id="preview-container" class="mt-4 hidden">
          <p class="text-sm text-green-700 font-medium mb-2">✅ Image uploaded successfully!</p>
          <img id="image-preview" class="rounded-lg max-w-xs border border-green-400 shadow-md mb-2" />
          <p id="predicted-breed" class="text-green-800 font-semibold"></p>
        </div>

        {% for field, label, options in [
          ('weight', 'Weight [Estimated from photo unless provided by user input]', ['Strawweight: <10lbs', 'Middleweight <40lbs', 'Heavyweight >40lbs']),
          ('chest_bridge_length', 'Length of Chest Bridge', ['Small: <9"', 'Medium: <28"', 'Large: >28"']),
          ('neck_circumference', 'Neck Circumference', ['Small: <10"', 'Medium: <18"', 'Large: >18"']),
          ('back_bridge_length', 'Length of Back Bridge', ['Small: <6"', 'Medium: <8.6"', 'Large: >8.6"']),
          ('belly_circumference', 'Belly Circumference', ['Small: <20"', 'Medium: <28"', 'Large: >28"'])
        ] %}
        <div>
          <label class="block text-sm font-medium text-gray-700">{{ label }}</label>
          <select name="{{ field }}" id="{{ field }}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
            <option value="" disabled selected>Select</option>
            {% for size in options %}
              <option value="{{ size }}">{{ size|e }}</option>
            {% endfor %}
          </select>
        </div>
        {% endfor %}
      </fieldset>

      <!-- User input fields -->
      <fieldset class="border border-gray-200 rounded-md p-4 space-y-4">
        <legend class="text-lg font-medium text-green-700 px-2 mb-2">Information from user input:</legend>

        <div>
          <label class="block text-sm font-medium text-gray-700">Dog Breed</label>
          <input type="text" name="breed" id="breed" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="e.g., Labrador" required>
        </div>

        {% set field_data = [
          ('hiking_yn', 'Will you regularly take your dog hiking?', 'For example, on trails, hills, forests, etc.'),
          ('hunting_yn', 'Will you regularly take your dog hunting?', 'E.g., upland game, waterfowl, tracking, etc.'),
          ('working_dog_yn', 'Is your dog a working/service/protection dog?', 'Guide, police, military, security, emotional support, etc.'),
          ('water_activities_yn', 'Does your dog regularly engage in water activities with its harness on?', 'Swimming, dock diving, paddleboarding, etc.'),
          ('dog_sports_yn', 'Is your dog regularly involved in sports, if so, which ones?', 'Agility, flyball, bikejoring, etc.'),
          ('leash_pulling_yn', 'Do you have problems with your dog pulling on the leash and need a solution?', 'Select "Yes" if you\'re actively trying to reduce pulling.'),
          ('dog_growing_age_yn', 'Is your dog still growing (under 6 months old)?', 'We\'re asking because puppies have special fit and adjustability needs.'),
          ('cleaning_experience_yn', 'Do you have experience cleaning and know how to maintain a dog\'s harness?', 'Some gear types need regular maintenance.'),
          ('heat_sensitive_yn', 'Does your dog overheat easily or live in a hot climate?', 'Yes if your dog lives in a climate above 80°F regularly, is a flat-faced (brachycephalic) breed (e.g. pug, bulldog), or has a thick coat (e.g. chow chow, golden retriever, husky). We\'ll recommend breathable gear like mesh harnesses')
        ] %}
        {% for field, label, tooltip in field_data %}
          <div>
            <label class="block text-sm font-medium text-gray-700">
              {{ label }}
              <span title="{{ tooltip }}" class="text-gray-400 cursor-help ml-1">❓</span>
            </label>
            <select name="{{ field }}" id="{{ field }}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
             <option value="" disabled selected>Select</option>
             <option value="Yes">Yes</option>
             <option value="No">No</option>
            </select>
          </div>
        {% endfor %}

        <!-- Add inside the form -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Activity Level</label>
          <select name="activity_level" id="activity_level" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
            <option value="" disabled selected>Select</option>
            <option value="low">Low</option>
            <option value="moderate">Moderate</option>
            <option value="high">High</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Aggression Level</label>
          <select name="aggression_level" id="aggression_level" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
            <option value="" disabled selected>Select</option>
            <option value="low">Low</option>
            <option value="moderate">Moderate</option>
            <option value="high">High</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Climate</label>
          <select name="climate" id="climate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
            <option value="" disabled selected>Select</option>
            <option value="hot">Hot</option>
            <option value="moderate">Moderate</option>
            <option value="cold">Cold</option>
          </select>
        </div>
      </fieldset>

      <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded shadow transition">
        Get Recommendation
      </button>
    </form>

    <div id="result" class="mt-10 hidden p-6 bg-white border border-emerald-200 rounded shadow-md">
      <h2 class="text-2xl text-green-700 font-bold mb-2 flex items-center gap-2">
        <i data-lucide="check-circle" class="w-5 h-5 text-green-700"></i>
        Recommended Gear
      </h2>
      <ul id="recommendation-list" class="list-disc list-inside text-gray-700"></ul>
      <p id="recommendation-message" class="mb-4 font-medium text-gray-800"></p>
    </div>
  </div>
</section>

<style>
  body {
    font-family: 'Inter', sans-serif;
  }
  button[type="submit"] {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  button[type="submit"]:hover {
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(34, 197, 94, 0.6);
  }
</style>

<script>
  lucide.createIcons();

  const form = document.getElementById('demo-form');
  const resultBox = document.getElementById('result');
  const recommendationList = document.getElementById('recommendation-list');

  form.addEventListener('submit', async (e) => {
  e.preventDefault();

  const formData = new FormData(form); // form element includes all inputs + file with correct names

  const response = await fetch('/full_recommendation', {
    method: 'POST',
    body: formData
  });

  const result = await response.json();

  if (result.status !== "success") {
    alert("Recommendation failed: " + (result.message || "Unknown error"));
    return;
  }

  // Show image preview
  const previewBox = document.getElementById("preview-container");
  const previewImage = document.getElementById("image-preview");
  previewImage.src = URL.createObjectURL(form.dog_image.files[0]);
  previewBox.classList.remove("hidden");

  // Show breed prediction
  const predictedBreed = document.getElementById("predicted-breed");
  const topBreed = result.top_breeds && result.top_breeds[0] ? result.top_breeds[0].breed : "Unknown";
  predictedBreed.textContent = `Predicted breed: ${topBreed}`;

  // Autofill breed input field
  document.getElementById('breed').value = topBreed;

  // Show gear recommendation
  const rec = result.gear_recommendation;
  const recommendationList = document.getElementById('recommendation-list');
  document.getElementById('recommendation-message').innerHTML = `<strong>Recommended Gear:</strong>`;
  recommendationList.innerHTML = `
    <li><strong>Collar:</strong> ${rec.collar}</li>
    <li><strong>Harness:</strong> ${rec.harness}</li>
    <li><strong>Leash:</strong> ${rec.leash}</li>
    <li><strong>Material Note:</strong> ${rec.material_note} </li>
  `;

  document.getElementById('result').classList.remove('hidden');
});
  
</script>

{% endblock %}
